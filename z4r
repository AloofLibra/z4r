#!/bin/sh
set -e

OWNER="AloofLibra"
REPO="zapret4rocket"
BRANCH="GV-Fix"
RAW_BASE="https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}"

Z4R_MAIN="/opt/z4r.sh"
Z4R_LIB="/opt/lib"

mkdir -p "$Z4R_LIB"

fetch() {
  # fetch <repo_rel_path> <dest_file>
  rel="$1"
  dst="$2"
  tmp="${dst}.tmp"
  curl -fsSL --max-time 20 "${RAW_BASE}/${rel}" | sed 's/\r$//' > "$tmp"
  mv -f "$tmp" "$dst"
}

# 1) Всегда обновляем entrypoint
fetch "z4r.sh" "$Z4R_MAIN"
chmod +x "$Z4R_MAIN"

# 2) Вытаскиваем из z4r.sh список модулей: source "$SCRIPT_DIR/lib/xxx.sh"
mods="$(sed -n 's|^[[:space:]]*source[[:space:]]\\+\"\\$SCRIPT_DIR/lib/\\([^\"]\\+\\)\".*|\\1|p' "$Z4R_MAIN")"

# 3) Докачиваем минимально нужные lib/*.sh
for m in $mods; do
  [ -s "${Z4R_LIB}/$m" ] || fetch "lib/$m" "${Z4R_LIB}/$m"
done

# 4) Запуск (строка важна для совместимости): opt/z4r.sh "$@"
exec bash /opt/z4r.sh "$@"
